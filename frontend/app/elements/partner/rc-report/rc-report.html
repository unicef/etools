
<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../common/etools-ajax/etools-ajax.html">
<link rel="import" href="../../common/locations-autocomplete/locations-autocomplete.html">
<link rel="import" href="../../common/etools-datepicker/etools-datepicker.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-list/iron-list.html">

<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../../bower_components/moment-element/moment-with-locales-import.html">

  


<dom-module id="rc-report">
  <style>
  .custom {
    --primary-background-color: #FFFFFF;
  }
  
  </style>
  <template>
    <etools-ajax
          auto
          id="ajax"
          url="[[url]]"
          handle-as="json"
          on-response="handleResponse"
          debounce-duration="300">
    </etools-ajax>
    <etools-ajax
          auto
          id="ajaxPost"
          on-response="handleSubmitResponse"
          on-error="handleSubmitError">
    </etools-ajax>
   
  <h2>Report on: {{rc.indicator.name}}</h2>
  
  <div>
      <p>Current Progress = {{rc.current_progress}}</p>
      <p>Target = {{rc.target}}</p>
      <p>Indicator = {{rc.indicator.name}}</p>
  </div>
  
  <div>
    <paper-button class="btn" on-tap="showNewReportDialog" raised>Add Report</paper-button>
    <template is="dom-repeat" items="{{indicatorReports}}" id="reports" as="report" sort="_sortDate">
        <div>
          <p>
            Reported on: {{dateFormat(report.modified, 'LL')}}, 
            Location: {{report.location}},
            Reported: {{report.total}}
          </p>
        </div>
    </template>
    <!--  -->

    <paper-dialog class="custom" id="newReportDialog" modal on-iron-overlay-closed="dismissDialog">
      <p>New Report: </p>
      <paper-dialog-scrollable>
      <br>
        <paper-input label="Total Reporting" type="number" id="reportTotal" required></paper-input>
        <br>
        <p>Location: 
          <locations-autocomplete id="locationSelected"
              autocomplete-url="{{appData.locationsAutocompleteEp}}">
          </locations-autocomplete>
        </p>
        <br>
        <p>From: {{fromPrettyDate}}</p>
        <input id="fromDate" type="hidden" value="{{fromJsonDate}}">
        <etools-datepicker pretty-date="{{fromPrettyDate}}" json-date="{{fromJsonDate}}"></etools-datepicker>

        <p>To: {{toPrettyDate}}</p>
        <input id="toDate" type="hidden" value="{{toJsonDate}}">
        <etools-datepicker pretty-date="{{toPrettyDate}}" json-date="{{toJsonDate}}"></etools-datepicker>
        <br>
    </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>Submit</paper-button>
      </div>
      
    </paper-dialog>
  </div>


  
  </template>

</dom-module>


<script>
(function() {
    // jscs:disable
  'use strict';
  Polymer({
    is: 'rc-report',
    properties: {
      appData: {
        type: Object,
        // appData is received from the parent
        value: {}
      },
      interventionId: {
        type: Number,
        value: null,
        observer: 'changeUrl'
      },
      rcId: {
        type: Number,
        value: null,
        observer: 'changeUrl'
      },
      rc: {
        type: Object,
        value: null,
        observer: 'update_view'
      },
      indicatorReports: {
        type: Array,
        value: null,
      },
      url: {
        type: String,
        value: null
      }
    },
    ready: function() {
      //
    },
    dateFormat: function(date, format) {
      return moment(date).format(format);
    },
    changeUrl: function() {
      if (this.rcId && this.interventionId){
        this.rc = null;
        this.url = this.appData.getEndpoint.resultChainDetails(this.interventionId, this.rcId);
      } else {
        this.url = null;
      }
    },
    handleResponse: function(rsp) {
      //
      this.rc = rsp.detail.xhr.response;
      this.indicatorReports = this.rc.indicator_reports;
      console.log(this.rc);

    },
    handleSubmitResponse: function(rsp){
      console.log('handling submit', rsp.detail.xhr.response);
      this.set('indicatorReports', this.rc.indicator_reports.concat([rsp.detail.xhr.response]));
      this.rc.indicator_reports.push(rsp.detail.xhr.response);
      this.$.reports.render();
    },
    handleSubmitError: function(rsp) {
      console.log(rsp.detail.error);
    },
    _validateSubmision: function() {
      if (!this.$.locationSelected.value){
        window.alert('location needed');
        return false;
      }
      if (!this.$.reportTotal.value){
        window.alert('Report number needed');
        return false;
      }
      return true;
    },
    _submitReport: function() {
      var myReq = this.$.ajaxPost;
      //TODO: Validate for location
      if (!this._validateSubmision()){
        return;
      }
      myReq.body = {
        'result_chain': this.rcId,
        'disaggregation': {},
        'total': this.$.reportTotal.value,
        'start': this.$.fromDate.value,
        'end': this.$.toDate.value,
        'location': this.$.locationSelected.value
      };
      myReq.method = 'POST';
      myReq.url = this.appData.getEndpoint.newIndicatorReport(this.interventionId, this.rcId);
      myReq.sendPostRequest();
    },
    showNewReportDialog: function() {
      this.$.newReportDialog.toggle();
    },
    dismissDialog: function(event) {
      console.log('dismissing inside rc-report');
      if (event.detail.confirmed) {
        this._submitReport();
      }
      event.stopPropagation();
    },
    update_view: function() {
      var params = this.params;
      var interventions = this.interventions;
      if (!interventions || !params) { return; }

      var intervention = _.find(interventions, function(item) {
        console.log('item:', item);
        return item.id.toString() === params.rcIntvId;
      });
      console.log(intervention);

      // assuuming we have params otherwise we would not get to this view

    },
    _sortDate: function(a, b) {
      return a.modified < b.modified ? 1 : -1;
      //return a.total < b.total ? 1 : -1;
    }
  });
})();

</script>