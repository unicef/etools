

<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <my-customel></my-customel>

@group Seed Elements
@element my-customel
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="etools-ajax">

  <template>
    <iron-ajax
          auto
          id="customAjax"
          handle-as="json"
          on-response="handleResponse"
          on-error="handleError"
          method="[[method]]"
          params="[[params]]"
          debounce-duration="300">
    </iron-ajax>
  </template>

</dom-module>



<script>
(function() {
    // jscs:disable
  'use strict';
  Polymer({
    is: 'etools-ajax',
    properties: {
      authToken: {
        type: String,
        value: ''
      },
      method: {
        type: String,
        method: 'GET'
      },
      params: {
        type: Object,
        value: null
      },
      body: {
        type: Object,
        value: null
      },
      url: {
        type: String,
        value: null,
        observer: '_prepareRequest'
      }
    },

    handleError: function(request, error){
      console.log('handling the error from etools-ajax');
      console.log('add error checking and validation here');
      // TODO: alert with needed errors.
      console.error([error.error, 'while loading', request.srcElement.url].join(': '));
      this.fire('error', {
        request: request,
        error: error.error
      }, {bubbles: false});
    },

    handleResponse: function(rsp) {
      //console.log('handling the response from etools-ajax')
      //console.log(rsp.detail.xhr.response, rsp.detail.xhr)
      //console.log(rsp.detail.xhr.responseURL);
      //console.log(rsp.srcElement.url);
      // TODO: move this logic into default behaviours
      if (rsp.detail.xhr.responseURL !== rsp.srcElement.url){
        console.error('expected link did not work, got redirected',rsp.detail.xhr.responseURL, rsp.srcElement.url);
        // TODO: if we get redirected to login.. trigger a global redirect mechanism
        // this._handleUnexpectedResponse();
        return;
      }
      this.fire('response', rsp.detail, {bubbles: false});
    },
    _getCSRFCookie: function() {
      var name = 'csrftoken';
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
      }
      return cookieValue;
    },
    _csrfSafeMethod: function(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    },

    _prepareRequest: function(newUrl){
      if ((this.method !== undefined) && (!this._csrfSafeMethod(this.method))) {
        console.log('unsafe method', this.method);
        var csrfToken = this._getCSRFCookie();
        this.$.customAjax.body = this.body;
        this.$.customAjax.contentType = 'application/json';
        this.$.customAjax.headers = {
          'X-CSRFToken': csrfToken
        };
      }
      this.$.customAjax.url = newUrl;
    }

    
  });
})();

</script>