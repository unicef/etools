# Generated by Django 2.2.7 on 2020-08-07 12:08
from dateutil.relativedelta import relativedelta
from django.db import migrations


def get_quarters_range(start, end):
    """first date included, last excluded for every period in range"""
    if not start or not end:
        return []

    quarters = []
    while start < end:
        period_end = min(start + relativedelta(months=3), end)
        quarters.append((start, period_end))
        start = period_end

    return quarters


def create_time_frames(apps, schema_editor):
    Intervention = apps.get_model('partners', 'Intervention')
    InterventionTimeFrame = apps.get_model('reports', 'InterventionTimeFrame')

    for intervention in Intervention.objects.filter(start__isnull=False, end__isnull=False):
        for i, quarter in enumerate(get_quarters_range(intervention.start, intervention.end)):
            InterventionTimeFrame.objects.get_or_create(
                intervention=intervention, quarter=i + 1, start_date=quarter[0], end_date=quarter[1]
            )


class Migration(migrations.Migration):
    dependencies = [
        ('reports', '0028_auto_20200807_1207'),
        ('partners', '0051_auto_20200722_1257'),
    ]

    operations = [
        migrations.RunPython(create_time_frames, migrations.RunPython.noop),
    ]
