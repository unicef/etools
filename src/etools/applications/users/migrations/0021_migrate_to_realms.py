# Generated by Django 3.2.6 on 2022-08-18 09:37
import sys
import logging

from django.db import migrations, transaction, connection, models


def check_user_profile_exists(apps, user):
    UserProfile = apps.get_model('users', 'UserProfile')

    if not hasattr(user, 'profile'):
        logging.warning(f"User {user.id}: {user.username} has no profile. "
                        f"Adding a user profile..")
        user.profile = UserProfile.objects.create(user=user)
        return False
    return True


def get_user_countries(apps, user):
    Country = apps.get_model('users', 'Country')
    countries_qs = Country.objects.filter(
        models.Q(id=user.profile.country_id) |
        models.Q(id=user.profile.country_override_id) |
        models.Q(id__in=user.profile.countries_available.values_list('pk', flat=True))
    ).exclude(name__in=['Global'])
    return countries_qs


def set_user_country_to_uat(user, uat_country):
    # If the user has no country set, add UAT to country and deactivate the user..")
    user.profile.country = uat_country
    user.profile.country_override = uat_country
    user.profile.save(update_fields=['country_override'])
    user.profile.countries_available.add(uat_country)

    user.is_active = False
    user.save(update_fields=['is_active'])


def fwd_migrate_to_user_realms(apps, schema_editor):
    # Don't run migration when testing
    if "test" in sys.argv:
        return
    User = apps.get_model('users', 'User')
    Realm = apps.get_model('users', 'Realm')
    Country = apps.get_model('users', 'Country')
    Group = apps.get_model('auth', 'Group')
    Organization = apps.get_model('organizations', 'Organization')

    no_profile, no_countries, no_realms = 0, 0, 0
    unicef_org, _ = Organization.objects.get_or_create(
        name='UNICEF',
        vendor_number='UNICEF',
        defaults={
            'organization_type': 'UN Agency',
            'cso_type': 'International'
        }
    )
    external_psea_org, _ = Organization.objects.get_or_create(
        name='EXTERNAL PSEA ASSESSORS',
        vendor_number='EXTERNAL PSEA ASSESSORS',
    )
    uat_country = Country.objects.get(name='UAT')

    unicef_user_group, _ = Group.objects.get_or_create(name="UNICEF User")
    external_psea_group, _ = Group.objects.get_or_create(name="PSEA Assessor")
    auditor_group, _ = Group.objects.get_or_create(name="Auditor")
    tpm_group, _ = Group.objects.get_or_create(name="Third Party Monitor")
    ip_viewer_group, _ = Group.objects.get_or_create(name="IP Viewer")

    logging.info(f'Processing {User.objects.count()} users..')

    for user in User.objects.all() \
            .select_related('profile', 'profile__country', 'profile__country_override',
                            'purchase_order_auditorstaffmember',
                            'tpmpartners_tpmpartnerstaffmember') \
            .prefetch_related('groups', 'profile__countries_available'):

        if not check_user_profile_exists(apps, user):
            no_profile += 1

        countries = list(get_user_countries(apps, user))
        if not countries:
            set_user_country_to_uat(user, uat_country)
            no_countries += 1

        groups = list(user.groups.all())
        is_unicef_user = user.groups.filter(name__contains='UNICEF').count() > 0 or user.email.endswith('@unicef.org')
        auditor_staff = hasattr(user, 'purchase_order_auditorstaffmember') and user.purchase_order_auditorstaffmember
        tpm_staff = hasattr(user, 'tpmpartners_tpmpartnerstaffmember') and user.tpmpartners_tpmpartnerstaffmember

        realm_list = []

        if is_unicef_user:
            for country in countries:
                for group in groups + [unicef_user_group]:
                    realm_list.append(dict(
                        user_id=user.id,
                        country_id=country.id,
                        organization_id=unicef_org.id,
                        group_id=group.id,
                        is_active=user.is_active
                    ))

        if auditor_staff:
            auditor_organization = auditor_staff.auditor_firm.organization
            if not auditor_organization:
                logging.info(
                    f"Auditor Firm with id:{auditor_staff.auditor_firm.id} for staff user {user.id} "
                    f"has no organization set. Skipping..")
            else:
                for country in countries:
                    for group in groups + [auditor_group]:
                        realm_list.append(dict(
                            user_id=user.id,
                            country_id=country.id,
                            organization_id=auditor_organization.id,
                            group_id=group.id,
                            is_active=not auditor_staff.hidden
                        ))

        if tpm_staff:
            tpm_organization = tpm_staff.tpm_partner.organization
            if not tpm_organization:
                logging.info(
                    f"TPM Partner with id:{tpm_staff.tpm_partner.id} for staff user {user.id} "
                    f"has no organization set. Skipping..")
            else:
                for country in countries:
                    for group in groups + [tpm_group]:
                        realm_list.append(dict(
                            user_id=user.id,
                            country_id=country.id,
                            organization_id=tpm_organization.id,
                            group_id=group.id,
                            is_active=user.is_active
                        ))

        # assign external pca group even for partner staff members since we cannot access tenants from here.
        # partners.0108 will remove this group if staff member exists
        if not any([is_unicef_user, auditor_staff, tpm_staff]):
            for country in countries:
                realm_list.append(dict(
                    user_id=user.id,
                    country_id=country.id,
                    organization_id=external_psea_org.id,
                    group_id=external_psea_group.id,
                    is_active=user.is_active
                ))

        if user.profile.country:
            user_active_country = user.profile.country
        else:
            user_active_country = user.profile.country_override

        if not realm_list:
            logging.info(f'No realms available for user {user.id} on country: {user_active_country.name}')
            no_realms += 1
        else:
            unique_realms = [dict(t) for t in {tuple(sorted(d.items())) for d in realm_list}]
            Realm.objects.bulk_create([Realm(**realm_dict) for realm_dict in unique_realms])

            # update user profile with organization from current country
            active_country_realm = user.realms.filter(country=user_active_country).first()
            if active_country_realm is None:
                # update user profile with organization from last realm
                user.profile.organization = Organization.objects.get(id=unique_realms[-1]['organization_id'])
            else:
                user.profile.organization = active_country_realm.organization
            user.profile.save(update_fields=['organization'])

    logging.info(f'{no_realms} users had no realms created because they are on Global country '
                 f'or the organization of the partner where is staff is None - no vendor_number')
    logging.info(f'{no_profile} users had no profile.')
    logging.info(f'{no_countries} users that had no countries set, were added to UAT.')


class Migration(migrations.Migration):

    dependencies = [
        ('purchase_order', '0011_alter_auditorfirm_organization'),
        ('tpmpartners', '0009_alter_tpmpartner_organization'),
        ('users', '0020_realms'),
    ]

    operations = [
        migrations.RunPython(fwd_migrate_to_user_realms, migrations.RunPython.noop),

        migrations.RenameField(
            model_name='user',
            old_name='groups',
            new_name='old_groups',
        ),
        migrations.AlterField(
            model_name='user',
            name='old_groups',
            field=models.ManyToManyField(blank=True, help_text='The groups this user belongs to. A user will get all permissions granted to each of their groups.', related_name='user_set', related_query_name='user', to='auth.Group', verbose_name='Old Groups'),
        ),
        migrations.RenameField(
            model_name='userprofile',
            old_name='countries_available',
            new_name='old_countries_available',
        ),
        migrations.AlterField(
            model_name='userprofile',
            name='old_countries_available',
            field=models.ManyToManyField(blank=True, related_name='accessible_by', to='users.Country', verbose_name='Old Countries Available'),
        ),
    ]
