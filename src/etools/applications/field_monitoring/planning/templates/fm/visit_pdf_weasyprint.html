{% load humanize static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ ma.reference_number }}</title>
    <style type="text/css">
        @page {
            margin: 1in 0.85in;
            @bottom-right {
                content: counter(page) " of " counter(pages);
                font-size: 10px;
                font-family: 'Roboto', 'Noto', sans-serif;
            }
        }
        body {
            font-family: 'Roboto', 'Noto', sans-serif;
            font-size: 10pt;
            margin: 0;
        }
        .content { font-size: 10pt; }
        .label { font-size: 12pt; font-weight: bold; }
        .value { font-size: 12pt; padding: 5px; }
        .main_title { font-size: 20pt; font-weight: lighter; color: #0099ff; }
        .content-section { font-size: 16pt; font-weight: lighter; color: #0099ff; }
        .right { width: 50%; }
        a.printable:link::after, a.printable:visited::after {
            content: " [" attr(href) "] ";
        }
        table { border-collapse: collapse; }
        hr { border: none; border-top: 1px solid #a6a6a6; margin: 8px 0; }
    </style>
</head>
<body>
{% if error %}
    PDF could not be generated properly: <br> {{ error }}
{% else %}
<div class="content">
    <table style="background-color: #0099ff; height: 1in; width: 100%; margin-bottom: 8px;">
        <tr>
            <td style="width: 70%">
                <img src="{% static 'images/UNICEF_logo_with_text_white.png' %}" style="display: block; width: 3.17in; height: 0.5in; margin-left: 0.19in;" alt="UNICEF">
            </td>
            <td>
                <div style="color: #FFFFFF;">
                    <span class="label">Workspace:</span>
                    <span class="value">{{ workspace|default_if_none:"-" }}</span>
                </div>
            </td>
        </tr>
    </table>
    <hr>

    <div class="main_title">{{ ma.reference_number }}</div>
    <table>
        <tr>
            <td class="right">
                <div><span class="label">Start Date:</span> <span class="value">{{ ma.start_date|date:"d-M-y"|default_if_none:"-" }}</span></div>
            </td>
            <td>
                <div><span class="label">End Date:</span> <span class="value">{{ ma.end_date|date:"d-M-y"|default_if_none:"-" }}</span></div>
            </td>
        </tr>
        <tr>
            <td><div><span class="label">Status:</span> <span class="value">{{ ma.get_status_display }}</span></div></td>
            <td><div><span class="label">Field offices:</span> <span class="value">{{ field_offices|default_if_none:"-" }}</span></div></td>
        </tr>
        {% if mission_completion_date %}
        <tr>
            <td><div><span class="label">Mission completion date:</span> <span class="value">{{ mission_completion_date|date:"d-M-y" }}</span></div></td>
            <td></td>
        </tr>
        {% endif %}
    </table>
    <br/>
    <div><span class="label">Sections:</span> <span class="value">{{ sections }}</span></div>
    <div><span class="label">Location:</span> <span class="value">{{ location|default_if_none:"-" }}</span></div>
    <br/>
    <div><span class="label">Team Members:</span> <span class="value">{{ team_members|default_if_none:"-" }}</span></div>
    <div><span class="label">Visit Lead:</span> <span class="value">{{ ma.visit_lead|default_if_none:"-" }}</span></div>
    <br/>
    <div class="content-section">ENTITIES TO MONITOR:</div>
    <div><span class="label">Partner:</span> <span class="value">{{ partners|default_if_none:"-" }}</span></div>
    <div><span class="label">CP Outputs:</span> <span class="value">{{ cp_outputs|default_if_none:"-" }}</span></div>
    <div><span class="label">PD/SSFAS:</span> <span class="value">{{ interventions|default_if_none:"-" }}</span></div>
    <br/>
    <div class="content-section">OVERALL FINDING:</div>
    {% regroup overall_findings by entity_name as overall_findings_list %}
    {% for finding in overall_findings_list %}
        <div><span class="label">ENTITY:</span> <span class="value">{{ finding.grouper }}</span></div>
        {% for finding in finding.list %}
            <div><span class="label">STATUS:</span> <span class="value">{% if finding.on_track == True %}On Track{% elif finding.on_track == False %}Off Track{% else %}Not Monitored{% endif %}</span></div>
            <div class="value">{{ finding.narrative_finding|safe|default:"-"|linebreaks }}</div>
        {% endfor %}
    {% endfor %}
    <br/>
    <div class="content-section">SUMMARY FINDINGS:</div><br/>
    {% regroup summary_findings by entity_name as summary_findings_list %}
    {% for finding in summary_findings_list %}
        <div><span class="label">ENTITY:</span> <span class="value">{{ finding.grouper }}</span></div>
        <table border="1">
            {% for finding in finding.list %}
            <tr><td class="right value">{{ finding.question_text }}</td><td class="value">{{ finding.value|default_if_none:"-"|linebreaks }}</td></tr>
            {% endfor %}
        </table><br/>
    {% endfor %}
    <br/>
    <div class="content-section">DATA COLLECTED:</div><br/>
    {% regroup data_collected by method as data_collected_list %}
    {% for checklist in data_collected_list %}
        {% for checkl in checklist.list %}
            <div><span class="label">Team Member:</span> <span class="value">{{ checkl.team_member }}</span></div>
            <div><span class="label">Method:</span> <span class="value">{{ checkl.method }}</span></div>
            <div><span class="label">Source:</span> <span class="value">{{ checkl.source }}</span></div>
            {% for overall in checkl.overall %}
                <div><span class="label">Entity:</span> <span class="value">{{ overall.entity_name }}</span></div>
                <div><span class="label">Overall Finding:</span> <span class="value">{{ overall.narrative_finding|safe|default:"-"|linebreaks }}</span></div>
                <table border="1">
                    {% for finding in overall.findings %}
                    <tr><td class="right value">{{ finding.question_text }}</td><td class="value">{{ finding.value|default_if_none:"-"|linebreaks }}</td></tr>
                    {% endfor %}
                </table><br/>
            {% endfor %}
        {% endfor %}<br/><br/>
    {% endfor %}
    <br/>
    <div class="content-section">RELATED DOCUMENTS:</div>
    {% for related_att in related_attachments %}
    <table><tr><td class="right"><span class="label">Date Uploaded:</span> <span class="value">{{ related_att.date_uploaded }}</span></td><td><span class="label">Document Type:</span> <span class="value">{{ related_att.doc_type }}</span></td></tr>
    <tr><td colspan="2"><span class="label">File Attachment:</span> <span class="value"><a href="{{ related_att.url_path }}" class="printable">{{ related_att.filename }}</a></span></td></tr></table><hr>
    {% endfor %}<br/>
    <div class="content-section">REPORTED DOCUMENTS:</div>
    {% for reported_att in reported_attachments %}
    <table><tr><td class="right"><span class="label">Date Uploaded:</span> <span class="value">{{ reported_att.date_uploaded }}</span></td><td><span class="label">Document Type:</span> <span class="value">{{ reported_att.doc_type }}</span></td></tr>
    <tr><td colspan="2"><span class="label">File Attachment:</span> <span class="value"><a href="{{ reported_att.url_path }}" class="printable">{{ reported_att.filename }}</a></span></td></tr></table><hr>
    {% endfor %}<br/>
    <div class="content-section">CHECKLIST DOCUMENTS:</div>
    {% for checklist_att in checklist_attachments %}
    <table>
        <tr><td class="right"><span class="label">Method:</span> <span class="value">{{ checklist_att.method }}</span></td><td><span class="label">Data Collector:</span> <span class="value">{{ checklist_att.data_collector }}</span></td></tr>
        <tr><td class="right"><span class="label">Method Type:</span> <span class="value">{{ checklist_att.method_type }}</span></td><td></td></tr>
        <tr><td class="right"><span class="label">Related To:</span> <span class="value">{{ checklist_att.related_to }}</span></td><td><span class="label">Related Name:</span> <span class="value">{{ checklist_att.related_name }}</span></td></tr>
        <tr><td class="right"><span class="label">Date Uploaded:</span> <span class="value">{{ checklist_att.date_uploaded }}</span></td><td><span class="label">Document Type:</span> <span class="value">{{ checklist_att.doc_type }}</span></td></tr>
        <tr><td colspan="2"><span class="label">File Attachment:</span> <span class="value"><a href="{{ checklist_att.url_path }}" class="printable">{{ checklist_att.filename }}</a></span></td></tr>
    </table><hr>
    {% endfor %}
    <br/>
    <div class="content-section">ACTION POINTS:</div>
    {% for ap in action_points %}
    <span class="label">#{{ forloop.counter }}</span>
    <div><span class="label">Reference Number:</span> <span class="value">{{ ap.reference_number }}</span></div>
    <div><span class="label">Is High Priority:</span> <span class="value">{{ ap.is_high_priority }}</span></div>
    <div><span class="label">Description:</span> <span class="value">{{ ap.description }}</span></div><br/>
    <table border="1">
        <tr><td><span class="label">Status:</span> <span class="value">{{ ap.status }}</span></td><td><span class="label">Due Date:</span> <span class="value">{{ ap.due_date }}</span></td></tr>
        <tr><td><span class="label">Assigned To:</span> <span class="value">{{ ap.assigned_to }}</span></td><td><span class="label">Assigned By:</span> <span class="value">{{ ap.assigned_by }}</span></td></tr>
        <tr><td><span class="label">Section:</span> <span class="value">{{ ap.section }}</span></td><td><span class="label">Office:</span> <span class="value">{{ ap.office }}</span></td></tr>
        <tr><td><span class="label">Related To:</span> <span class="value">{{ ap.related_to }}</span></td><td><span class="label">Category:</span> <span class="value">{{ ap.category }}</span></td></tr>
    </table>
    <div><span class="label">Actions Taken:</span></div>
    {% for comment in ap.comments %}
    <br/><div><span class="label">Comment:</span> <span class="value">{{ comment.comment }}</span></div>
    <table><tr><td><span class="label">User:</span> <span class="value">{{ comment.user }}</span></td><td><span class="label">Submit Date:</span> <span class="value">{{ comment.submit_date }}</span></td></tr>
    <tr><td colspan="2"><span class="label">Supporting document:</span> <span class="value"><a href="{{ comment.url_path }}" class="printable">{{ comment.filename }}</a></span></td></tr></table>
    {% endfor %}
    <hr><br/>
    {% endfor %}
</div>
{% endif %}
</body>
</html>
