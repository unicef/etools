# Generated by Django 3.2.6 on 2023-04-18 13:46
import json

from django.db import migrations
from django.utils import timezone


def update_audits_completed(apps, schema_editor):
    PartnerOrganization = apps.get_model('partners', 'PartnerOrganization')
    Audit = apps.get_model('audit', 'Audit')
    SpecialAudit = apps.get_model('audit', 'SpecialAudit')

    for partner in PartnerOrganization.objects.all():
        if isinstance(partner.hact_values, str):
            partner.hact_values = json.loads(partner.hact_values)

        if 'audits' not in partner.hact_values:
            continue

        if 'completed' not in partner.hact_values['audits']:
            continue

        audits = Audit.objects.filter(
            partner=partner,
            year_of_audit=timezone.now().year
        ).exclude(status='cancelled')

        s_audits = SpecialAudit.objects.filter(
            partner=partner,
            year_of_audit=timezone.now().year
        ).exclude(status='cancelled')

        completed_audit = audits.count() + s_audits.count()
        partner.hact_values['audits']['completed'] = completed_audit
        partner.save()


class Migration(migrations.Migration):

    dependencies = [
        ('partners', '0111_auto_20230315_0932'),
        ('audit', '0024_audit_year_of_audit'),
    ]

    operations = [
        migrations.RunPython(update_audits_completed, migrations.RunPython.noop),
    ]
