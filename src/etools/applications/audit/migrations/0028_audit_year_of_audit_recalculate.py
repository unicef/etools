# Generated by Django 3.2.6 on 2023-04-14 07:53

from django.db import migrations, models
from django.db.models import F, Subquery, OuterRef
from django.db.models.functions import Extract
from django.utils import timezone

import etools.applications.audit.models


def fill_year_of_audit_for_special_audit(apps, schema_editor):
    Engagement = apps.get_model('audit', 'Engagement')
    Engagement.objects.filter(
        engagement_type='sa',
        date_of_draft_report_to_ip__isnull=False,
    ).update(
        year_of_audit=Subquery(
            Engagement.objects.filter(
                pk=OuterRef('pk')
            ).annotate(
                end_year=Extract("date_of_draft_report_to_ip", "year")
            ).values('end_year')[:1]
        )
    )
    Engagement.objects.filter(
        engagement_type='sa',
        date_of_draft_report_to_ip__isnull=True,
    ).update(
        year_of_audit=timezone.now().year,
    )


class Migration(migrations.Migration):

    dependencies = [
        ('audit', '0027_engagement_staff_members'),
    ]

    operations = [
        migrations.RunPython(fill_year_of_audit_for_special_audit, migrations.RunPython.noop),
    ]
