# Generated by Django 4.2.3 on 2025-09-29 10:24

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone
import etools.applications.last_mile.models
import etools.applications.utils.validators
import model_utils.fields


class Migration(migrations.Migration):

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('last_mile', '0012_squash_dispense_unicef_release_poi'),
    ]

    operations = [
        migrations.CreateModel(
            name='AuditConfiguration',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created', model_utils.fields.AutoCreatedField(default=django.utils.timezone.now, editable=False, verbose_name='created')),
                ('modified', model_utils.fields.AutoLastModifiedField(default=django.utils.timezone.now, editable=False, verbose_name='modified')),
                ('name', models.CharField(default='Default Audit Configuration', help_text='Name for this audit configuration', max_length=100, unique=True, verbose_name='Configuration Name')),
                ('is_enabled', models.BooleanField(default=True, help_text='Master switch to enable or disable all audit logging', verbose_name='Enable Audit Logging')),
                ('track_system_users', models.BooleanField(default=True, help_text='Whether to audit changes made by staff/superuser accounts', verbose_name='Track System Users')),
                ('tracked_fields', models.JSONField(blank=True, default=etools.applications.last_mile.models.default_tracked_fields, help_text='List of Item model fields to track in audit logs', verbose_name='Tracked Fields')),
                ('excluded_user_ids', models.JSONField(blank=True, default=list, help_text='List of user IDs to exclude from audit logging', verbose_name='Excluded User IDs')),
                ('max_entries_per_item', models.PositiveIntegerField(default=100, help_text='Maximum number of audit entries to keep per item (0 = unlimited)', verbose_name='Max Entries Per Item')),
                ('fk_field_mappings', models.JSONField(blank=True, default=etools.applications.last_mile.models.default_fk_field_mappings, help_text='Mapping of foreign key fields to their related model fields', verbose_name='Foreign Key Field Mappings')),
                ('is_active', models.BooleanField(default=True, help_text='Whether this is the active configuration (only one can be active)', verbose_name='Is Active Configuration')),
            ],
            options={
                'verbose_name': 'Audit Configuration',
                'verbose_name_plural': 'Audit Configurations',
                'ordering': ['-is_active', 'name'],
            },
        ),
        migrations.CreateModel(
            name='ItemAuditLog',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created', model_utils.fields.AutoCreatedField(default=django.utils.timezone.now, editable=False, verbose_name='created')),
                ('modified', model_utils.fields.AutoLastModifiedField(default=django.utils.timezone.now, editable=False, verbose_name='modified')),
                ('item_id', models.PositiveIntegerField(verbose_name='Item ID')),
                ('action', models.CharField(choices=[('CREATE', 'Created'), ('UPDATE', 'Updated'), ('DELETE', 'Deleted'), ('SOFT_DELETE', 'Soft Deleted')], max_length=20, verbose_name='Action')),
                ('changed_fields', models.JSONField(blank=True, help_text='List of field names that were changed', null=True, verbose_name='Changed Fields')),
                ('old_values', models.JSONField(blank=True, help_text='Previous values of tracked fields', null=True, verbose_name='Previous Values')),
                ('new_values', models.JSONField(blank=True, help_text='New values of tracked fields', null=True, verbose_name='New Values')),
                ('transfer_info', models.JSONField(blank=True, help_text='Transfer details at the time of audit', null=True, verbose_name='Transfer Information')),
                ('material_info', models.JSONField(blank=True, help_text='Material details at the time of audit', null=True, verbose_name='Material Information')),
                ('critical_changes', models.JSONField(blank=True, help_text='Important changes like transfer or material changes', null=True, verbose_name='Critical Changes')),
                ('user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='item_audit_logs', to=settings.AUTH_USER_MODEL, verbose_name='User')),
            ],
            options={
                'verbose_name': 'Item Audit Log',
                'verbose_name_plural': 'Item Audit Logs',
                'ordering': ['-created'],
            },
        ),
        migrations.RemoveField(
            model_name='item',
            name='transfers_history',
        ),
        migrations.AlterField(
            model_name='item',
            name='base_uom',
            field=models.CharField(choices=[('BAG', 'BAG'), ('BOT', 'BOT'), ('BOX', 'BOX'), ('CAR', 'CAR'), ('DRM', 'DRM'), ('DZ', 'DZ'), ('EA', 'EA'), ('KG', 'KG'), ('L', 'L'), ('M', 'M'), ('PAA', 'PAA'), ('PAC', 'PAC'), ('RM', 'RM'), ('ROL', 'ROL'), ('SET', 'SET'), ('TBE', 'TBE'), ('TO', 'TO'), ('VL', 'VL'), ('CAN', 'CAN')], max_length=30, null=True),
        ),
        migrations.AlterField(
            model_name='item',
            name='uom',
            field=models.CharField(choices=[('BAG', 'BAG'), ('BOT', 'BOT'), ('BOX', 'BOX'), ('CAR', 'CAR'), ('DRM', 'DRM'), ('DZ', 'DZ'), ('EA', 'EA'), ('KG', 'KG'), ('L', 'L'), ('M', 'M'), ('PAA', 'PAA'), ('PAC', 'PAC'), ('RM', 'RM'), ('ROL', 'ROL'), ('SET', 'SET'), ('TBE', 'TBE'), ('TO', 'TO'), ('VL', 'VL'), ('CAN', 'CAN')], max_length=30, null=True),
        ),
        migrations.AlterField(
            model_name='material',
            name='original_uom',
            field=models.CharField(choices=[('BAG', 'BAG'), ('BOT', 'BOT'), ('BOX', 'BOX'), ('CAR', 'CAR'), ('DRM', 'DRM'), ('DZ', 'DZ'), ('EA', 'EA'), ('KG', 'KG'), ('L', 'L'), ('M', 'M'), ('PAA', 'PAA'), ('PAC', 'PAC'), ('RM', 'RM'), ('ROL', 'ROL'), ('SET', 'SET'), ('TBE', 'TBE'), ('TO', 'TO'), ('VL', 'VL'), ('CAN', 'CAN')], max_length=30),
        ),
        migrations.AlterField(
            model_name='material',
            name='other',
            field=models.JSONField(blank=True, null=True, validators=[etools.applications.utils.validators.JSONSchemaValidator(json_schema={'additionalProperties': True, 'properties': {'uom_map': {'additionalProperties': {'type': 'number'}, 'propertyNames': {'enum': ['BAG', 'BOT', 'BOX', 'CAR', 'DRM', 'DZ', 'EA', 'KG', 'L', 'M', 'PAA', 'PAC', 'RM', 'ROL', 'SET', 'TBE', 'TO', 'VL', 'CAN']}, 'type': 'object'}}, 'title': "Json schema for item 'other' field", 'type': 'object'})], verbose_name='Other Details'),
        ),
        migrations.DeleteModel(
            name='ItemTransferHistory',
        ),
        migrations.AddIndex(
            model_name='itemauditlog',
            index=models.Index(fields=['item_id'], name='last_mile_i_item_id_2d5800_idx'),
        ),
        migrations.AddIndex(
            model_name='itemauditlog',
            index=models.Index(fields=['action'], name='last_mile_i_action_864823_idx'),
        ),
        migrations.AddIndex(
            model_name='itemauditlog',
            index=models.Index(fields=['user'], name='last_mile_i_user_id_0b510f_idx'),
        ),
    ]
