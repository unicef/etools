# -*- coding: utf-8 -*-
# Generated by Django 1.9.10 on 2017-07-07 20:36
from __future__ import unicode_literals

import django.contrib.postgres.fields.jsonb
from django.db import migrations, models
import django_fsm

def reverse(apps, schema_editor):
    raise BaseException('cannot reverse this migration')


def migrate_interventions_by_valid_status(apps, schema_editor):
    # Migrate the statuses that can be migrated
    # for remediation after all migrations run... run a script to re-validate all interventions
    #  and let the auto-transitions update the records

    Intervention = apps.get_model('partners', 'Intervention')

    closed_interventions = Intervention.objects.filter(status='implemented').\
        update(status='closed', metadata={'old_status': 'implemented',
                                          'migrated': True})

    cancelled = Intervention.objects.filter(status='cancelled').\
        update(status='draft', metadata={'old_status': 'cancelled',
                                         'migrated': True})

    print('Interventions Updated to implemented from closed: {}'.format(closed_interventions))
    print('Interventions moved to Draft from cancelled: {}'.format(cancelled))




def remove_old_agreements(apps, schema_editor):
    IC = 'IC'
    AWP = 'AWP'
    Agreement = apps.get_model('partners', 'Agreement')
    deleted = Agreement.objects.filter(agreement_type__in=[IC, AWP]).delete()
    print('IC and AWP Agreements deleted: {}'.format(deleted))


def migrate_agreements_by_status(apps, schema_editor):
    Agreement = apps.get_model('partners', 'Agreement')
    agreements_migrated = Agreement.objects.filter(status='active').update(status='signed')
    agreements_draft = Agreement.objects.filter(status='cancelled').update(status='draft')

    print('Agreements Updated to signed from active: {}'.format(agreements_migrated))
    print('Agreements moved to Draft from cancelled: {}'.format(agreements_draft))


class Migration(migrations.Migration):

    dependencies = [
        ('partners', '0041_auto_20170706_1731'),
    ]

    operations = [
        migrations.AlterModelManagers(
            name='agreement',
            managers=[
            ],
        ),
        migrations.AddField(
            model_name='intervention',
            name='metadata',
            field=django.contrib.postgres.fields.jsonb.JSONField(blank=True, default=dict, null=True),
        ),
        migrations.RunPython(
            migrate_interventions_by_valid_status, reverse_code=reverse),
        migrations.RunPython(
            remove_old_agreements, reverse_code=reverse),
        migrations.RunPython(
            migrate_agreements_by_status, reverse_code=reverse),
        migrations.AlterField(
            model_name='agreement',
            name='agreement_type',
            field=models.CharField(choices=[('PCA', 'Programme Cooperation Agreement'), ('SSFA', 'Small Scale Funding Agreement'), ('MOU', 'Memorandum of Understanding')], max_length=10),
        ),
        migrations.AlterField(
            model_name='agreement',
            name='status',
            field=django_fsm.FSMField(blank=True, choices=[('draft', 'Draft'), ('signed', 'Signed'), ('ended', 'Ended'), ('suspended', 'Suspended'), ('terminated', 'Terminated')], default='draft', max_length=32),
        ),
        migrations.AlterField(
            model_name='intervention',
            name='status',
            field=django_fsm.FSMField(blank=True,
                                      choices=[('draft', 'Draft'), ('signed', 'Signed'), ('active', 'Active'),
                                               ('ended', 'Ended'), ('closed', 'Closed'), ('suspended', 'Suspended'),
                                               ('terminated', 'Terminated')], default='draft', max_length=32),
        ),
        migrations.AlterModelManagers(
            name='agreement',
            managers=[
                ('view_objects', models.manager.Manager()),
            ],
        ),
    ]
