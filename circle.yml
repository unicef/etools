machine:
  python:
    version: 2.7.11
  services:
    - docker
    - postgresql
  environment:
    DJANGO_SETTINGS_MODULE: EquiTrack.settings.production
    CPLUS_INCLUDE_PATH: /usr/include/gdal
    C_INCLUDE_PATH: /usr/include/gdal
    DATABASE_URL: postgis:///circle_test

dependencies:
  override:
    - sudo apt-get install -y libgdal-dev python-dev
    - pip install -U pip
    - pip install -r EquiTrack/requirements/production.txt

test:
  pre:
    - psql -d template1 -c 'create extension hstore;' # needed for django hstore
  override:
    - >
      case $CIRCLE_BRANCH in
        develop|staging|master)
          # build and run tests in docker
          docker build --rm=false -t unicef/etools:$CIRCLE_BRANCH .
          HOSTIP=`ip -4 addr show scope global dev eth0 | grep inet | awk '{print \$2}' | cut -d / -f 1`
          docker run -it -e "DATABASE_URL=postgis://ubuntu@docker:5432/circle_test" -e SECRET_KEY --add-host=docker:${HOSTIP} unicef/etools:$CIRCLE_BRANCH bash runtests.sh
          ;;
        *)
          # run tests outside docker
          cd EquiTrack && bash runtests.sh;;
      esac

deployment:
   hub:
     branch: [develop, staging, master, prp-refactoring]
     commands:
       - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
       - docker push unicef/etools:$CIRCLE_BRANCH
