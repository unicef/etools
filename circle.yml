machine:
  python:
    version: 2.7.11
  services:
    - docker
    - postgresql
  environment:
    DJANGO_SETTINGS_MODULE: EquiTrack.settings.production
    CPLUS_INCLUDE_PATH: /usr/include/gdal
    C_INCLUDE_PATH: /usr/include/gdal
    DATABASE_URL: postgis:///circle_test

dependencies:
  override:
    - sudo apt-get install -y libgdal-dev python-dev
    - pip install -U pip
    - pip install -r EquiTrack/requirements/production.txt

test:
  pre:
    - psql -d template1 -c 'create extension hstore;' # needed for django hstore
  override:
    - cd EquiTrack && bash runtests.sh

deployment:
   hub:
     branch: [develop, staging, master, ci-cache-docker-image]
     commands:
       - docker build --rm=false -t unicef/etools:$CIRCLE_BRANCH .
       - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
       - docker push unicef/etools:$CIRCLE_BRANCH
